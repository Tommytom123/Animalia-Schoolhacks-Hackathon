<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Animalia</title>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css"href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />

    <style>
    .menu {
      width: 15%;
      height: 100vh;
      min-width: 16rem;
      padding: 20px 0px 0px 20px;
      float: left;

    } 
    .main {
      width: 85%;
      height: 100vh;
      padding: 20px 0px 0px 10px;
      float: left;

    }

    </style>
  <script>
    
  </script>
  </head>
  <body style="overflow: hidden;">
      
    <!--Info popup-->


  <div class="modal fade" id="info_popup" tabindex="-1" aria-labelledby="modal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal_title">{animal_name}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <font id="ext_info"> </font>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

    <!--Side Bar-->
    <div class="menu">
        <div class="card border-secondary shadow-lg " style="width: 100%; height: 98%;">
          <h1 class="card-header"> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" fill="currentColor" class="bi bi-flower1" viewBox="0 0 16 16">
            <path d="M6.174 1.184a2 2 0 0 1 3.652 0A2 2 0 0 1 12.99 3.01a2 2 0 0 1 1.826 3.164 2 2 0 0 1 0 3.652 2 2 0 0 1-1.826 3.164 2 2 0 0 1-3.164 1.826 2 2 0 0 1-3.652 0A2 2 0 0 1 3.01 12.99a2 2 0 0 1-1.826-3.164 2 2 0 0 1 0-3.652A2 2 0 0 1 3.01 3.01a2 2 0 0 1 3.164-1.826zM8 1a1 1 0 0 0-.998 1.03l.01.091c.012.077.029.176.054.296.049.241.122.542.213.887.182.688.428 1.513.676 2.314L8 5.762l.045-.144c.248-.8.494-1.626.676-2.314.091-.345.164-.646.213-.887a4.997 4.997 0 0 0 .064-.386L9 2a1 1 0 0 0-1-1zM2 9l.03-.002.091-.01a4.99 4.99 0 0 0 .296-.054c.241-.049.542-.122.887-.213a60.59 60.59 0 0 0 2.314-.676L5.762 8l-.144-.045a60.59 60.59 0 0 0-2.314-.676 16.705 16.705 0 0 0-.887-.213 4.99 4.99 0 0 0-.386-.064L2 7a1 1 0 1 0 0 2zm7 5-.002-.03a5.005 5.005 0 0 0-.064-.386 16.398 16.398 0 0 0-.213-.888 60.582 60.582 0 0 0-.676-2.314L8 10.238l-.045.144c-.248.8-.494 1.626-.676 2.314-.091.345-.164.646-.213.887a4.996 4.996 0 0 0-.064.386L7 14a1 1 0 1 0 2 0zm-5.696-2.134.025-.017a5.001 5.001 0 0 0 .303-.248c.184-.164.408-.377.661-.629A60.614 60.614 0 0 0 5.96 9.23l.103-.111-.147.033a60.88 60.88 0 0 0-2.343.572c-.344.093-.64.18-.874.258a5.063 5.063 0 0 0-.367.138l-.027.014a1 1 0 1 0 1 1.732zM4.5 14.062a1 1 0 0 0 1.366-.366l.014-.027c.01-.02.021-.048.036-.084a5.09 5.09 0 0 0 .102-.283c.078-.233.165-.53.258-.874a60.6 60.6 0 0 0 .572-2.343l.033-.147-.11.102a60.848 60.848 0 0 0-1.743 1.667 17.07 17.07 0 0 0-.629.66 5.06 5.06 0 0 0-.248.304l-.017.025a1 1 0 0 0 .366 1.366zm9.196-8.196a1 1 0 0 0-1-1.732l-.025.017a4.951 4.951 0 0 0-.303.248 16.69 16.69 0 0 0-.661.629A60.72 60.72 0 0 0 10.04 6.77l-.102.111.147-.033a60.6 60.6 0 0 0 2.342-.572c.345-.093.642-.18.875-.258a4.993 4.993 0 0 0 .367-.138.53.53 0 0 0 .027-.014zM11.5 1.938a1 1 0 0 0-1.366.366l-.014.027c-.01.02-.021.048-.036.084a5.09 5.09 0 0 0-.102.283c-.078.233-.165.53-.258.875a60.62 60.62 0 0 0-.572 2.342l-.033.147.11-.102a60.848 60.848 0 0 0 1.743-1.667c.252-.253.465-.477.629-.66a5.001 5.001 0 0 0 .248-.304l.017-.025a1 1 0 0 0-.366-1.366zM14 9a1 1 0 0 0 0-2l-.03.002a4.996 4.996 0 0 0-.386.064c-.242.049-.543.122-.888.213-.688.182-1.513.428-2.314.676L10.238 8l.144.045c.8.248 1.626.494 2.314.676.345.091.646.164.887.213a4.996 4.996 0 0 0 .386.064L14 9zM1.938 4.5a1 1 0 0 0 .393 1.38l.084.035c.072.03.166.064.283.103.233.078.53.165.874.258a60.88 60.88 0 0 0 2.343.572l.147.033-.103-.111a60.584 60.584 0 0 0-1.666-1.742 16.705 16.705 0 0 0-.66-.629 4.996 4.996 0 0 0-.304-.248l-.025-.017a1 1 0 0 0-1.366.366zm2.196-1.196.017.025a4.996 4.996 0 0 0 .248.303c.164.184.377.408.629.661A60.597 60.597 0 0 0 6.77 5.96l.111.102-.033-.147a60.602 60.602 0 0 0-.572-2.342c-.093-.345-.18-.642-.258-.875a5.006 5.006 0 0 0-.138-.367l-.014-.027a1 1 0 1 0-1.732 1zm9.928 8.196a1 1 0 0 0-.366-1.366l-.027-.014a5 5 0 0 0-.367-.138c-.233-.078-.53-.165-.875-.258a60.619 60.619 0 0 0-2.342-.572l-.147-.033.102.111a60.73 60.73 0 0 0 1.667 1.742c.253.252.477.465.66.629a4.946 4.946 0 0 0 .304.248l.025.017a1 1 0 0 0 1.366-.366zm-3.928 2.196a1 1 0 0 0 1.732-1l-.017-.025a5.065 5.065 0 0 0-.248-.303 16.705 16.705 0 0 0-.629-.661A60.462 60.462 0 0 0 9.23 10.04l-.111-.102.033.147a60.6 60.6 0 0 0 .572 2.342c.093.345.18.642.258.875a4.985 4.985 0 0 0 .138.367.575.575 0 0 0 .014.027zM8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
          </svg>Animalia</h1>
          <div class="card-body">
            
            

            <p id="location"></p>
            
            

            <nav aria-label="breadcrumb" style="position: absolute; bottom: 0; width: 100%;">
              <ol class="breadcrumb">
                <li class="breadcrumb-item active" aria-current="page">Home</li>
                <li class="breadcrumb-item"><a href="#">Page 2</a></li>
                <li class="breadcrumb-item"><a href="#">Page 3</a></li>
              </ol>
            </nav>
  
          </div>
        </div>
      </div>
    <!--MAP-->
    <div class="main">
        <div class="card border-success" style="width: 98%; height: 98%;">
            <div class="card-body">
               
              <div style="width: 100%; height: 100%;" id="mapContainer"></div>
              
              <!--JS for the map-->
              <script>	
                // Initialize Map
                var platform = new H.service.Platform({
                  'apikey': 'X5taNHfxMoYunIFl7jP3AnvGhGvwKKRi8sQqRq7zorI'
                });

                var x = document.getElementById("location");
                  
                function getLocation() {
                    if (navigator.geolocation) {
                      navigator.geolocation.getCurrentPosition(showPosition);
                      
                    } else { 
                      x.innerHTML = "Geolocation is not supported by this browser.";
                    }
                  }
                  
                function showPosition(position) {
                  x.innerHTML = "Latitude: " + position.coords.latitude + 
                  "<br>Longitude: " + position.coords.longitude;
                  lat =position.coords.latitude;
                  long = position.coords.longitude;
                  map.setCenter({lat:lat, lng:long});
                  var current_loc = new H.map.Marker({lat: lat, lng: long});
                  map.addObject(current_loc);
                  map.setZoom(12);

                  fetch('/all_data', {
                      headers : {
                          'Content-Type' : 'application/json'
                      },
                      method : 'POST',
                      body : JSON.stringify( {
                          'data_request' : null
                      })
                  })
                  .then(function (data){

                      if(data.ok) {   //Getting the CSV values
                        key_list = [];
                        animals_list = [];
                        lats_list = [];
                        longs_list = [];
                        types_list = [];
                        data.json()
                          .then(function(data) {
                              console.log(data);
                              for (let i = 0; i < data.length; i++) { //For each of the values create a pointer on the map
                                addDomMarker(map,data[i]["latitude"],data[i]["longitude"],data[i]["key"],data[i]["type"]) //map, lat, long, key, type
                              }
                          });
                          
                      }
                      else {
                          throw Error('Something went wrong');
                      }
                  })
                  .catch(function(error) {
                      console.log(error);
                  });



                  
                }
                lat = 0
                long = 0
                getLocation();


                var maptypes = platform.createDefaultLayers();

                var map = new H.Map(
                  document.getElementById('mapContainer'),
                  maptypes.raster.terrain.map,
                  {
                    zoom: 10,
                    center: { lat: lat, lng: long }  
                  });
                  
                window.addEventListener('resize', function () {
                      map.getViewPort().resize(); 
                });

                var mapEvents = new H.mapevents.MapEvents(map);

                map.addEventListener('tap', function(evt) {
                  console.log(evt.type, evt.currentPointer.type); 
                });
                
                map.addEventListener('mapviewchangeend', function(){
                  console.log(map.getZoom())
                  if (map.getZoom() < 8){
                    console.log("TOO BIG")
                    for (i in map.getObjects()) {
                      map.getObjects()[i].setVisibility(false);
                    }     
                  } else{
                    for (i in map.getObjects()) {
                      map.getObjects()[i].setVisibility(true);
                    }
                  }
                })

                var behavior = new H.mapevents.Behavior(mapEvents);
                var ui = H.ui.UI.createDefault(map, maptypes);      
                
                
                function addDomMarker(map, lat, long, key, type) {
                  var outerElement = document.createElement('div'),
                      innerElement = document.createElement('div');

                  outerElement.style.userSelect = 'none';
                  outerElement.style.webkitUserSelect = 'none';
                  outerElement.style.msUserSelect = 'none';
                  outerElement.style.mozUserSelect = 'none';
                  outerElement.style.cursor = 'default';
                  
                  innerElement.style.color = 'red';
                  if (type == "animal"){
                    innerElement.style.backgroundColor = 'blue';
                    
                    innerElement.innerHTML = 'A';
                  } else {
                    innerElement.style.backgroundColor = 'green';

                    innerElement.innerHTML = 'P';
                  }
                  innerElement.style.border = '2px solid black';
                  innerElement.style.font = 'normal 12px arial';
                  innerElement.style.lineHeight = '12px'

                  innerElement.style.paddingTop = '2px';
                  innerElement.style.paddingLeft = '4px';
                  innerElement.style.width = '20px';
                  innerElement.style.height = '20px';

                  innerElement.style.marginTop = '-10px';
                  innerElement.style.marginLeft = '-10px';

                  outerElement.appendChild(innerElement);


                  function changeOpacity(evt) {
                    evt.target.style.opacity = 0.6;
                  };

                  function changeOpacityToOne(evt) {
                    evt.target.style.opacity = 1;
                  };

                  //create dom icon and add/remove opacity listeners
                  var domIcon = new H.map.DomIcon(outerElement, {
                    // the function is called every time marker enters the viewport
                    onAttach: function(clonedElement, domIcon, domMarker) {
                      clonedElement.addEventListener('mouseover', changeOpacity);
                      clonedElement.addEventListener('mouseout', changeOpacityToOne);
                      clonedElement.addEventListener('click', function(){ popup_info(key)}); //When the element is clicked bring up a popup with the details about the animal or plant
                    },
                    // the function is called every time marker leaves the viewport
                    onDetach: function(clonedElement, domIcon, domMarker) {
                      clonedElement.removeEventListener('mouseover', changeOpacity);
                      clonedElement.removeEventListener('mouseout', changeOpacityToOne);
                    }
                  });

                  var Marker1 = new H.map.DomMarker({lat: lat, lng: long}, {
                    icon: domIcon
                  });
                  map.addObject(Marker1);
                }
                
                function popup_info(key) { //Each enimal has a key/which item they are in the CSV
                    console.log("ping clicked")
                    
                    info_popup = document.getElementById("info_popup")
                    $("#info_popup").modal("toggle");

                    fetch('/fetch', {
                      headers : {
                          'Content-Type' : 'application/json'
                      },
                      method : 'POST',
                      body : JSON.stringify( {
                          'key' : key
                      })
                  })
                  .then(function (response){

                      if(response.ok) {
                          response.json()
                          .then(function(response) {
                              console.log(response);
                              
                              modal_title = document.getElementById("modal_title");
                              modal_title.innerHTML = response["species"]
                              ext_info = document.getElementById("ext_info")
                              ext_info.innerHTML = response["extra_info"]
                              

                          });
                      }
                      else {
                          throw Error('Something went wrong');
                      }
                  })
                  .catch(function(error) {
                      console.log(error);


                  });

                }
            </script>
      
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
  </body>
</html>
